# KWeb GDS Viewer Setup

This document explains how to set up the KWeb GDS viewer integration.

## Overview

KWeb provides an interactive web-based viewer for GDS (Graphic Database System) layout files. Our integration serves GDS files generated by gdsfactory Python scripts through an authenticated interface.

## Setup Steps

### 1. Install Dependencies

KWeb and gdsfactory are already in `requirements.txt`:
```
kweb>=0.1.0
gdsfactory>=7.0.0
```

### 2. Rebuild Docker Containers

After adding kweb to requirements, rebuild the containers:

```bash
cd /home/user/a6hub/backend

# Rebuild backend and worker containers
docker compose build backend celery-worker

# Restart the services
docker compose up -d backend celery-worker
```

### 3. Verify Installation

Check if kweb is properly installed:

```bash
docker compose exec backend python -c "import kweb; print('KWeb version:', kweb.__version__)"
```

## Architecture

### Components

1. **kweb_service.py**: Manages temporary GDS file storage
   - Creates project-specific subdirectories
   - Handles file cleanup

2. **kweb.py**: API endpoints for GDS viewing
   - `/api/v1/kweb/gds/{project_id}/{filename}` - Main viewer endpoint
   - `/api/v1/kweb/viewer/{project_id}/{filename}` - Direct viewer (proxied to kweb)
   - `/api/v1/kweb/assets/{path}` - Static assets (JS, CSS, fonts)
   - `/api/v1/kweb/download/{project_id}/{filename}` - Direct file download

3. **Frontend**: GDS Viewer Component
   - Displays below Monaco editor for Python files
   - Resizable with drag handle
   - Auto-refreshes after running Python scripts

### Authentication Flow

1. User authentication via JWT tokens
2. Token passed as query parameter for iframe requests
3. Token validated before serving GDS files
4. Static assets served without authentication

### File Storage

```
temp_dir/
├── {project_id}/
│   ├── file1.gds
│   └── file2.gds
└── {project_id}/
    └── file3.gds
```

KWeb is initialized with `temp_dir` as the base location and serves files using relative paths: `{project_id}/{filename}`.

## Usage

### Running Python Scripts

1. Create a Python file with gdsfactory code:
```python
import gdsfactory as gf

# Create a simple component
c = gf.components.rectangle(size=(10, 10))

# Export to GDS
c.write_gds("my_design.gds")
```

2. Click the "Run" button in the GDS viewer
3. The script executes in a Celery worker
4. Generated GDS files are automatically uploaded to MinIO
5. The viewer refreshes to display the generated GDS

### Viewing GDS Files

1. Select a Python file in the editor
2. GDS viewer appears below the editor
3. Corresponding GDS file (e.g., `script.py` → `script.gds`) is displayed
4. Interactive KLayout viewer shows the layout
5. Pan, zoom, and inspect layers

## Troubleshooting

### "KWeb not installed" message

- Rebuild Docker containers after adding kweb to requirements
- Verify kweb is in the Python environment
- Check Docker build logs for errors

### GDS file not found

- Run the Python script first to generate the GDS
- Check that the script calls `.write_gds(filename)`
- Verify the filename matches expected format

### Viewer shows placeholder

- Check backend logs for kweb initialization errors
- Ensure KLayout Python bindings are available
- Verify file permissions on temp directory

### Static assets not loading

- Check browser console for 404 errors
- Verify `/api/v1/kweb/assets/` endpoint is accessible
- Check that kweb app is properly initialized

## Development Notes

### Local Development

For local development without Docker:

```bash
# Install dependencies
pip install -r requirements.txt

# Verify installations
python -c "import kweb, gdsfactory; print('OK')"

# Run backend
uvicorn main:app --reload

# Run Celery worker (separate terminal)
celery -A app.workers.celery_app worker --loglevel=info --queues=python
```

### Testing

```bash
# Test kweb import
python -c "from kweb.viewer import get_app; print('KWeb OK')"

# Test gdsfactory
python -c "import gdsfactory as gf; c = gf.components.rectangle(); c.write_gds('test.gds'); print('GDS OK')"
```

## References

- [KWeb GitHub](https://github.com/gdsfactory/kweb)
- [gdsfactory Documentation](https://gdsfactory.github.io/gdsfactory/)
- [KLayout Python API](https://www.klayout.de/doc/code/index.html)
